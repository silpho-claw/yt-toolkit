<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YT Toolkit ‚Äî The Appiarist</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0a;
    --surface: #141414;
    --surface2: #1c1c1c;
    --border: #2a2a2a;
    --text: #f0f0f0;
    --text2: #888;
    --accent: #DD2B23;
    --accent-glow: rgba(221, 43, 35, 0.15);
    --green: #22c55e;
    --blue: #3b82f6;
    --yellow: #eab308;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  h1, h2, h3, h4 { font-family: 'Space Grotesk', sans-serif; }

  .app { max-width: 1200px; margin: 0 auto; padding: 24px; }

  .header {
    display: flex; align-items: center; gap: 16px;
    padding-bottom: 24px; border-bottom: 1px solid var(--border);
    margin-bottom: 32px;
  }
  .header h1 { font-size: 24px; font-weight: 700; }
  .header span { color: var(--text2); font-size: 14px; }
  .header .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }

  .setup {
    display: flex; gap: 12px; margin-bottom: 32px; flex-wrap: wrap;
  }
  .setup input, .setup select {
    background: var(--surface); border: 1px solid var(--border);
    color: var(--text); padding: 10px 14px; border-radius: 8px;
    font-size: 13px; font-family: 'DM Sans', sans-serif;
  }
  .setup input { flex: 1; min-width: 200px; }
  .setup input::placeholder { color: var(--text2); }
  .setup .key-saved { color: var(--green); font-size: 12px; align-self: center; }

  .photos {
    display: flex; gap: 12px; margin-bottom: 32px; align-items: center;
  }
  .photo-slot {
    width: 80px; height: 80px; border-radius: 12px;
    border: 2px dashed var(--border); display: flex;
    align-items: center; justify-content: center;
    cursor: pointer; overflow: hidden; position: relative;
    transition: border-color 0.2s;
  }
  .photo-slot:hover { border-color: var(--accent); }
  .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
  .photo-slot .plus { color: var(--text2); font-size: 24px; }
  .photo-slot .remove {
    position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7);
    color: #fff; border: none; border-radius: 50%; width: 20px; height: 20px;
    font-size: 12px; cursor: pointer; display: flex; align-items: center;
    justify-content: center;
  }
  .photos label { color: var(--text2); font-size: 13px; }

  .input-section { margin-bottom: 32px; }
  .input-section label {
    display: block; margin-bottom: 8px; font-weight: 600;
    font-family: 'Space Grotesk', sans-serif; font-size: 14px;
  }
  textarea {
    width: 100%; min-height: 160px; background: var(--surface);
    border: 1px solid var(--border); color: var(--text);
    padding: 16px; border-radius: 12px; font-size: 14px;
    font-family: 'DM Sans', sans-serif; resize: vertical;
    line-height: 1.6;
  }
  textarea::placeholder { color: var(--text2); }
  textarea:focus { outline: none; border-color: var(--accent); }

  .generate-row { display: flex; gap: 12px; margin-bottom: 32px; flex-wrap: wrap; }
  .btn {
    padding: 12px 24px; border-radius: 10px; border: none;
    font-family: 'Space Grotesk', sans-serif; font-weight: 600;
    font-size: 14px; cursor: pointer; transition: all 0.15s;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #c42520; }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-ghost { background: transparent; color: var(--text2); }
  .btn-ghost:hover { color: var(--text); }

  .results { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  @media (max-width: 768px) { .results { grid-template-columns: 1fr; } }

  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 20px; position: relative;
  }
  .card h3 {
    font-size: 14px; color: var(--text2); margin-bottom: 16px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }

  .thumbnail-grid {
    display: flex; flex-wrap: wrap; gap: 16px;
  }
  .thumbnail-item {
    border-radius: 12px; overflow: hidden; position: relative;
    aspect-ratio: 16/9; background: var(--surface2);
    display: flex; align-items: center; justify-content: center;
    flex: 1 1 calc(33% - 12px); min-width: 200px;
  }
  .thumbnail-item img { width: 100%; height: 100%; object-fit: cover; }
  .thumbnail-item .loading {
    color: var(--text2); font-size: 13px; text-align: center;
  }
  .thumbnail-actions {
    display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;
  }

  .title-list { display: flex; flex-direction: column; gap: 8px; }
  .title-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; background: var(--surface2);
    border-radius: 10px; cursor: pointer; transition: background 0.15s;
  }
  .title-item:hover { background: var(--border); }
  .title-item .num {
    font-family: 'Space Grotesk', sans-serif; font-weight: 700;
    color: var(--accent); font-size: 13px; min-width: 20px;
  }
  .title-item .text { font-size: 14px; flex: 1; line-height: 1.4; }
  .title-item .copy-icon { color: var(--text2); font-size: 12px; }

  .description-box {
    background: var(--surface2); border-radius: 10px;
    padding: 16px; font-size: 13px; line-height: 1.7;
    white-space: pre-wrap; color: var(--text); min-height: 200px;
    position: relative;
  }
  .description-box .copy-btn {
    position: absolute; top: 8px; right: 8px;
  }
  .desc-buttons {
    display: flex; gap: 8px; margin-top: 8px;
  }

  .prompt-preview {
    margin-top: 12px; padding: 12px; background: var(--surface2);
    border-radius: 8px; font-size: 11px; color: var(--text2);
    max-height: 100px; overflow-y: auto; white-space: pre-wrap;
  }

  .spinner {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.6s linear infinite;
    margin-right: 8px; vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: var(--surface2); color: var(--green); padding: 10px 20px;
    border-radius: 8px; font-size: 13px; z-index: 100;
    border: 1px solid var(--border);
    animation: fadeInUp 0.2s ease-out;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateX(-50%) translateY(10px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  .card.full { grid-column: 1 / -1; }

  .style-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
  .chip {
    padding: 6px 14px; border-radius: 20px; font-size: 12px;
    background: var(--surface2); border: 1px solid var(--border);
    cursor: pointer; transition: all 0.15s; color: var(--text2);
  }
  .chip.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
  .chip:hover { border-color: var(--text2); }

  .channel-info {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px; margin-bottom: 32px;
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
  }
  .channel-info .avatar {
    width: 48px; height: 48px; border-radius: 50%; background: var(--accent-glow);
    display: flex; align-items: center; justify-content: center; font-size: 24px;
    flex-shrink: 0;
  }
  .channel-info .meta { flex: 1; min-width: 200px; }
  .channel-info .meta h4 { font-size: 15px; margin-bottom: 2px; }
  .channel-info .meta p { color: var(--text2); font-size: 12px; line-height: 1.5; }
  .channel-info .edit-btn { align-self: flex-start; }

  .bio-editor {
    width: 100%; min-height: 80px; background: var(--surface2);
    border: 1px solid var(--border); color: var(--text);
    padding: 12px; border-radius: 8px; font-size: 12px;
    font-family: 'DM Sans', sans-serif; resize: vertical;
    line-height: 1.5; display: none;
  }
  .bio-editor.show { display: block; margin-top: 12px; }

  /* Tags */
  .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
  .tag-chip {
    padding: 6px 14px; border-radius: 20px; font-size: 12px;
    background: var(--surface2); border: 1px solid var(--border);
    cursor: pointer; transition: all 0.15s; color: var(--text);
  }
  .tag-chip:hover { background: var(--accent-glow); border-color: var(--accent); }

  /* Favorites */
  .favorites-section {
    margin-top: 48px; border-top: 1px solid var(--border); padding-top: 32px;
  }
  .favorites-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px; margin-top: 16px;
  }
  .fav-item {
    position: relative; border-radius: 12px; overflow: hidden;
    border: 1px solid var(--border); background: var(--surface);
  }
  .fav-item img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
  .fav-item .fav-meta {
    padding: 8px; font-size: 11px; color: var(--text2);
  }
  .fav-item .fav-remove {
    position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7);
    color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px;
    cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;
  }

  /* History */
  .history-section {
    margin-top: 48px; border-top: 1px solid var(--border); padding-top: 32px;
  }
  .history-header {
    display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom: 16px;
  }
  .history-header h2 { font-size: 18px; }
  .history-list { display: flex; flex-direction: column; gap: 12px; }
  .history-entry {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 16px; font-size: 13px;
  }
  .history-entry .h-type {
    font-size: 11px; text-transform: uppercase; color: var(--accent);
    font-weight: 600; margin-bottom: 4px;
  }
  .history-entry .h-time {
    font-size: 11px; color: var(--text2); margin-bottom: 8px;
  }
  .history-entry .h-content {
    white-space: pre-wrap; max-height: 100px; overflow-y: auto; line-height: 1.5;
  }
  .history-entry .h-content img {
    max-width: 200px; border-radius: 8px;
  }

  /* A/B Modal */
  .ab-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85);
    display: flex; align-items: center; justify-content: center;
    z-index: 200; flex-direction: column; gap: 24px;
  }
  .ab-modal .ab-row {
    display: flex; gap: 24px; align-items: center;
  }
  .ab-modal .ab-thumb {
    width: 360px; height: 202px; border-radius: 8px; overflow: hidden;
    cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s;
  }
  .ab-modal .ab-thumb:hover { border-color: var(--accent); }
  .ab-modal .ab-thumb img { width: 100%; height: 100%; object-fit: cover; }
  .ab-label { color: var(--text2); font-size: 13px; text-align: center; }

  /* Tweak input */
  .tweak-row {
    display: flex; gap: 8px; margin-top: 12px;
  }
  .tweak-row input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 8px 12px; border-radius: 8px;
    font-size: 13px; font-family: 'DM Sans', sans-serif;
  }

  /* YouTube URL input */
  .yt-url-row {
    display: flex; gap: 8px; margin-bottom: 12px; align-items: center;
  }
  .yt-url-row input {
    flex: 1; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); padding: 10px 14px; border-radius: 10px;
    font-size: 13px; font-family: 'DM Sans', sans-serif;
  }

  /* Preview toggle */
  .preview-toggle {
    display: inline-flex; align-items: center; gap: 8px; margin-bottom: 12px;
  }
  .preview-toggle button {
    padding: 4px 12px; border-radius: 6px; font-size: 12px;
    border: 1px solid var(--border); cursor: pointer;
    font-family: 'Space Grotesk', sans-serif; font-weight: 600;
  }
  .preview-toggle .active-preview { background: var(--accent); color: #fff; border-color: var(--accent); }
  .preview-toggle .inactive-preview { background: var(--surface2); color: var(--text2); }
</style>
</head>
<body>
<!-- Password Gate -->
<div id="authGate" style="display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px;">
  <div class="dot" style="width:12px;height:12px;border-radius:50%;background:var(--accent);margin-bottom:8px;"></div>
  <h2 style="font-family:'Space Grotesk',sans-serif;font-size:20px;">YT Toolkit</h2>
  <p style="color:var(--text2);font-size:13px;">Enter password to continue</p>
  <input type="password" id="passInput" placeholder="Password" style="background:var(--surface);border:1px solid var(--border);color:var(--text);padding:12px 20px;border-radius:10px;font-size:15px;font-family:'DM Sans',sans-serif;width:260px;text-align:center;" onkeydown="if(event.key==='Enter')checkPass()" autofocus />
  <button class="btn btn-primary" onclick="checkPass()" style="width:260px;">Enter</button>
  <p id="passError" style="color:var(--accent);font-size:12px;display:none;">Wrong password</p>
</div>

<div class="app" id="mainApp" style="display:none;">
  <!-- Header -->
  <div class="header">
    <div class="dot"></div>
    <h1>YT Toolkit</h1>
    <span>The Appiarist ‚Äî @thepawelk</span>
  </div>

  <!-- Channel Info -->
  <div class="channel-info">
    <div class="avatar">üêù</div>
    <div class="meta">
      <h4>The Appiarist ‚Äî @thepawelk</h4>
      <p id="channelBioPreview">React Native indie hacker building a hive of apps. Self-taught dev since 2017. Built and shipped 12+ apps (sold 2 on Flippa). Based in Poland. Building in public ‚Äî real revenue, real failures, no guru BS.</p>
    </div>
    <button class="btn btn-ghost edit-btn" onclick="toggleBioEditor()">Edit Bio</button>
  </div>
  <textarea class="bio-editor" id="bioEditor" placeholder="Edit your channel bio / about section. This context is used to write better descriptions."></textarea>

  <!-- API Keys -->
  <div class="setup">
    <input type="password" id="openaiKey" placeholder="OpenAI API key (sk-...)" />
    <input type="password" id="geminiKey" placeholder="Google Gemini API key" />
    <button class="btn btn-secondary" onclick="saveKeys()">Save Keys</button>
    <span class="key-saved" id="keySaved" style="display:none">‚úì Saved</span>
  </div>
  <p style="color:var(--text2);font-size:11px;margin-top:-24px;margin-bottom:24px;">Thumbnails use Gemini 2.5 Flash Image (nano-banana). Get a free API key at <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--accent)">aistudio.google.com/apikey</a></p>

  <!-- Photos -->
  <div class="photos" style="flex-wrap:wrap;">
    <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
      <div class="photo-slot" id="photo1" onclick="uploadPhoto(0)"><span class="plus">+</span></div>
      <span style="color:var(--text2);font-size:11px;">Your face</span>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
      <div class="photo-slot" id="photo2" onclick="uploadPhoto(1)"><span class="plus">+</span></div>
      <span style="color:var(--text2);font-size:11px;">Video frame</span>
    </div>
    <div id="extraPhotosContainer" style="display:flex;gap:12px;flex-wrap:wrap;"></div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
      <div class="photo-slot" onclick="addExtraPhoto()" style="border-style:dotted;"><span class="plus" style="font-size:18px;">+</span></div>
      <span style="color:var(--text2);font-size:11px;">Add image</span>
    </div>
    <input type="file" id="photoInput" accept="image/*" style="display:none" />
  </div>
  <p style="color:var(--text2);font-size:11px;margin-top:-20px;margin-bottom:24px;">Extra images (logos, screenshots, icons) get sent to Gemini to include in the thumbnail.</p>

  <!-- Feature 5: YouTube URL -->
  <div class="input-section">
    <label>YouTube URL (optional)</label>
    <div class="yt-url-row">
      <input type="text" id="ytUrlInput" placeholder="https://www.youtube.com/watch?v=..." />
      <button class="btn btn-secondary" onclick="fetchYouTubeInfo()" style="white-space:nowrap;">Fetch Info</button>
    </div>
  </div>

  <!-- Input -->
  <div class="input-section">
    <label>Video Topic / Transcript / Summary</label>
    <textarea id="topicInput" placeholder="Paste your video transcript, topic description, or a brief summary of what the video is about..."></textarea>
  </div>

  <!-- Thumbnail controls -->
  <div class="input-section">
    <label>Thumbnail Text <button class="btn btn-ghost" style="font-size:12px;padding:4px 10px;margin-left:8px;" onclick="suggestThumbTexts()">‚ú® Suggest from topic</button></label>
    <input type="text" id="thumbTextInput" placeholder='e.g. "CLOUD BOT MAGIC!" or "I SHIPPED IT"' style="width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:12px 16px;border-radius:10px;font-size:15px;font-family:'Space Grotesk',sans-serif;font-weight:700;" />
    <div id="thumbTextSuggestions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;"></div>
  </div>

  <div class="input-section">
    <label>Text Tone</label>
    <div class="style-chips" id="textToneChips">
      <div class="chip active" data-tone="curiosity">Curiosity Gap</div>
      <div class="chip" data-tone="provocative">Provocative</div>
      <div class="chip" data-tone="honest">Honest / Raw</div>
      <div class="chip" data-tone="hype">Hype / Excited</div>
      <div class="chip" data-tone="deadpan">Deadpan / Dry</div>
      <div class="chip" data-tone="contrarian">Contrarian</div>
      <div class="chip" data-tone="numbers">Numbers / Data</div>
      <div class="chip" data-tone="question">Question</div>
    </div>
  </div>

  <div class="input-section">
    <label>Text Visual Style</label>
    <div class="style-chips" id="textStyleChips">
      <div class="chip active" data-textstyle="bold-white">Bold White + Black Outline</div>
      <div class="chip" data-textstyle="yellow-bold">Yellow Bold</div>
      <div class="chip" data-textstyle="red-highlight">Red Highlight Box</div>
      <div class="chip" data-textstyle="neon-glow">Neon Glow</div>
      <div class="chip" data-textstyle="gradient-text">Gradient Text</div>
      <div class="chip" data-textstyle="3d-text">3D / Drop Shadow</div>
      <div class="chip" data-textstyle="handwritten">Handwritten / Marker</div>
      <div class="chip" data-textstyle="glitch">Glitch / Distorted</div>
    </div>
  </div>

  <div class="input-section">
    <label>Layout Style</label>
    <div class="style-chips" id="layoutStyleChips">
      <div class="chip active" data-style="face-left-text-right">Face Left + Text Right</div>
      <div class="chip" data-style="face-center-text-top">Face Center + Text Top</div>
      <div class="chip" data-style="dramatic">Dramatic Orange</div>
      <div class="chip" data-style="dramatic-blue">Dramatic Blue / Cyber</div>
      <div class="chip" data-style="dramatic-red">Dramatic Red / Urgent</div>
      <div class="chip" data-style="split">Split Screen</div>
      <div class="chip" data-style="podcast-style">Podcast / Talking Head</div>
      <div class="chip" data-style="face-with-icon">Face + Icon</div>
      <div class="chip" data-style="screenshot-reaction">Screenshot + Reaction</div>
      <div class="chip" data-style="breaking-news">Breaking News</div>
      <div class="chip" data-style="versus">VS / Versus</div>
      <div class="chip" data-style="ranking-list">Ranking List</div>
    </div>
  </div>

  <!-- Generate -->
  <div class="generate-row">
    <button class="btn btn-primary" id="generateAll" onclick="generateAll()">Generate All</button>
    <button class="btn btn-secondary" onclick="generateTitles()">Titles Only</button>
    <button class="btn btn-secondary" onclick="generateDescription()">Description Only</button>
    <button class="btn btn-secondary" onclick="generateThumbnail()">Thumbnail Only</button>
    <button class="btn btn-secondary" onclick="generateTags()">Tags Only</button>
  </div>

  <!-- Results -->
  <div class="results">
    <!-- Titles -->
    <div class="card">
      <h3>üìù Title Options</h3>
      <div class="title-list" id="titleResults">
        <div style="color:var(--text2);font-size:13px;">Generate to see title suggestions</div>
      </div>
    </div>

    <!-- Thumbnail -->
    <div class="card" id="thumbnailCard">
      <h3>üé® Thumbnail
        <!-- Feature 9: Dark/Light preview toggle -->
        <span class="preview-toggle" style="float:right;">
          <button class="active-preview" id="previewDarkBtn" onclick="setPreviewMode('dark')">Dark</button>
          <button class="inactive-preview" id="previewLightBtn" onclick="setPreviewMode('light')">Light</button>
        </span>
      </h3>
      <div class="thumbnail-grid" id="thumbnailResults">
        <div class="thumbnail-item">
          <div class="loading">Generate to create thumbnails</div>
        </div>
      </div>
      <div id="thumbnailPrompt"></div>
      <!-- Feature 1: Tweak input (shown after generation) -->
      <div id="tweakSection" style="display:none;">
        <div class="tweak-row">
          <input type="text" id="tweakInput" placeholder="Describe tweaks: e.g. 'make text bigger', 'darker background'..." />
          <button class="btn btn-secondary" onclick="tweakThumbnail()" style="white-space:nowrap;">Tweak</button>
        </div>
      </div>
    </div>

    <!-- Description -->
    <div class="card full">
      <h3>üìÑ Description</h3>
      <div class="description-box" id="descriptionResults">
        Generate to see description
      </div>
      <div class="desc-buttons" id="descButtons" style="display:none;">
        <button class="btn btn-secondary" style="font-size:12px;" onclick="copyDescriptionRaw()">Copy Text</button>
        <button class="btn btn-secondary" style="font-size:12px;" onclick="copyDescriptionMarkdown()">Copy as Markdown</button>
      </div>
    </div>

    <!-- Feature 3: Tags -->
    <div class="card full">
      <h3>üè∑Ô∏è Tags</h3>
      <div id="tagsResults">
        <div style="color:var(--text2);font-size:13px;">Generate to see tags</div>
      </div>
    </div>
  </div>

  <!-- Feature 2: Favorites -->
  <div class="favorites-section" id="favoritesSection">
    <h2 style="font-size:18px;margin-bottom:4px;">‚≠ê Favorites</h2>
    <p style="color:var(--text2);font-size:12px;margin-bottom:16px;">Saved thumbnails (max 20)</p>
    <div class="favorites-grid" id="favoritesGrid"></div>
  </div>

  <!-- Feature 10: History -->
  <div class="history-section" id="historySection">
    <div class="history-header" onclick="toggleHistory()">
      <h2>üìú History</h2>
      <span id="historyToggleIcon" style="color:var(--text2);font-size:18px;">‚ñ∂</span>
      <button class="btn btn-ghost" style="font-size:12px;margin-left:auto;" onclick="event.stopPropagation();clearHistory()">Clear History</button>
    </div>
    <div class="history-list" id="historyList" style="display:none;"></div>
  </div>
</div>

<!-- Feature 6: A/B Modal -->
<div class="ab-modal" id="abModal" style="display:none;" onclick="if(event.target===this)closeABModal()">
  <h3 style="color:var(--text);font-size:18px;">A/B Compare ‚Äî Click the winner</h3>
  <div class="ab-label">Light background (YouTube default)</div>
  <div class="ab-row" id="abRowLight" style="background:#fff;padding:16px;border-radius:12px;"></div>
  <div class="ab-label">Dark background (YouTube dark mode)</div>
  <div class="ab-row" id="abRowDark" style="background:#0F0F0F;padding:16px;border-radius:12px;"></div>
  <button class="btn btn-ghost" onclick="closeABModal()" style="margin-top:12px;">Cancel</button>
</div>

<script>
// ============================================================================
// AUTH
// ============================================================================
function checkPass() {
  const input = document.getElementById('passInput').value;
  if (input === 'theappiarist321') {
    sessionStorage.setItem('yt_auth', '1');
    showApp();
  } else {
    const err = document.getElementById('passError');
    err.style.display = 'block';
    document.getElementById('passInput').value = '';
    document.getElementById('passInput').focus();
    setTimeout(() => err.style.display = 'none', 2000);
  }
}

function showApp() {
  document.getElementById('authGate').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
}

if (sessionStorage.getItem('yt_auth') === '1') {
  window.addEventListener('DOMContentLoaded', showApp);
}

// ============================================================================
// CHANNEL CONTEXT
// ============================================================================
const CHANNEL = {
  name: "The Appiarist",
  handle: "@thepawelk",
  creator: "Pawe≈Ç Karniej",
  tagline: "Building a hive of apps",
  bio: `I'm building a hive of apps ‚Äî small projects, experiments, and products that compound over time.

Self-taught React Native developer since 2017. Based in Bia≈Çystok, Poland. I've built and shipped 12+ apps to the App Store ‚Äî sold 2 on Flippa, retired 2, and keep building new ones.

Current projects:
‚Ä¢ ShipReactNative ‚Äî React Native boilerplate with AI, payments, auth ($199)
‚Ä¢ Splonk ‚Äî macOS app for recording & editing app demos
‚Ä¢ GhostCommand ‚Äî voice-to-command macOS menu bar app
‚Ä¢ Newsletterytics ‚Äî newsletter analytics for Beehiiv & Mailchimp
‚Ä¢ YapperX ‚Äî voice memos ‚Üí tweets in your tone
‚Ä¢ Voxdrop ‚Äî AI-powered streamer donations (songs + voice drops)

My approach: Ship fast, be honest about what works and what doesn't, automate what you can, and keep building. I use AI and automation heavily ‚Äî including a personal AI assistant (CloudBot) that manages projects through Telegram.

I talk about: React Native, indie hacking, shipping apps, real revenue, AI-powered development, automation, and the vibecoding era.`,
  apps: [
    "Newsletterytics (newsletter analytics)",
    "YapperX (voice ‚Üí tweets)",
    "BeatAI (AI music practice)",
    "TeleprompterX (teleprompter)",
    "MoonLatte (caffeine tracking)",
    "VidNotes (video notes)",
    "Coldsmith (cold exposure tracking)",
    "FIFTN (focus timer)",
    "AIVidly (sold on Flippa)",
    "Rhava/Bibleily (sold on Flippa)",
  ],
  links: {
    twitter: "https://x.com/pawelkarniej",
    website: "https://pawelkarniej.com",
    boilerplate: "https://shipreactnative.com",
    linkedin: "https://linkedin.com/in/pawelkarniej",
    github: "https://github.com/Karniej",
  }
};

// ============================================================================
// BIO EDITOR
// ============================================================================
function toggleBioEditor() {
  const editor = document.getElementById('bioEditor');
  const isShowing = editor.classList.contains('show');
  if (isShowing) {
    const val = editor.value.trim();
    if (val) {
      CHANNEL.bio = val;
      localStorage.setItem('yt_channel_bio', val);
      document.getElementById('channelBioPreview').textContent = val.substring(0, 200) + (val.length > 200 ? '...' : '');
    }
    editor.classList.remove('show');
  } else {
    editor.value = localStorage.getItem('yt_channel_bio') || CHANNEL.bio;
    editor.classList.add('show');
    editor.focus();
  }
}

// ============================================================================
// STATE
// ============================================================================
let photos = [null, null];
let extraPhotos = [];
let currentPhotoIndex = 0;
let lastGeneratedImages = []; // Feature 1: store last generated thumbnail data URLs
let generatedDescriptionText = ''; // Feature 8: store raw description text
let previewMode = 'dark'; // Feature 9

// ============================================================================
// KEYS
// ============================================================================
function saveKeys() {
  const ok = document.getElementById('openaiKey').value.trim();
  const gk = document.getElementById('geminiKey').value.trim();
  if (ok) localStorage.setItem('yt_openai_key', ok);
  if (gk) localStorage.setItem('yt_gemini_key', gk);
  const el = document.getElementById('keySaved');
  el.style.display = 'inline';
  setTimeout(() => el.style.display = 'none', 2000);
}

function getKey(name) {
  return localStorage.getItem(`yt_${name}_key`) || '';
}

// Gemini Image
async function callGeminiImage(prompt, inputImageBase64 = null, secondImageBase64 = null, additionalImages = []) {
  const key = getKey('gemini');
  if (!key) { alert('Please enter your Google Gemini API key'); return null; }

  const parts = [];

  function addImage(dataUrl) {
    const match = dataUrl.match(/^data:([^;]+);base64,(.+)$/);
    if (match) parts.push({ inlineData: { mimeType: match[1], data: match[2] } });
  }

  if (inputImageBase64) addImage(inputImageBase64);
  if (secondImageBase64) addImage(secondImageBase64);
  additionalImages.forEach(img => addImage(img));

  parts.push({ text: prompt });

  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${key}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ parts }],
      generationConfig: {
        responseModalities: ['TEXT', 'IMAGE'],
      }
    })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(`Gemini error: ${err?.error?.message || res.statusText}`);
  }

  const data = await res.json();
  const responseParts = data?.candidates?.[0]?.content?.parts || [];
  
  for (const part of responseParts) {
    if (part.inlineData) {
      return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
    }
  }
  throw new Error('No image returned from Gemini. Try a different prompt.');
}

window.addEventListener('DOMContentLoaded', () => {
  const ok = getKey('openai');
  const gk = getKey('gemini');
  if (ok) document.getElementById('openaiKey').value = ok;
  if (gk) document.getElementById('geminiKey').value = gk;

  for (let i = 0; i < 2; i++) {
    const saved = localStorage.getItem(`yt_photo_${i}`);
    if (saved) { photos[i] = saved; renderPhoto(i); }
  }

  const savedBio = localStorage.getItem('yt_channel_bio');
  if (savedBio) {
    CHANNEL.bio = savedBio;
    document.getElementById('channelBioPreview').textContent = savedBio.substring(0, 200) + (savedBio.length > 200 ? '...' : '');
  }

  renderFavorites();
  renderHistory();
});

// ============================================================================
// PHOTOS
// ============================================================================
function uploadPhoto(index) {
  if (photos[index]) return;
  currentPhotoIndex = index;
  document.getElementById('photoInput').click();
}

document.getElementById('photoInput')?.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const img = new Image();
    img.onload = () => {
      const MAX = 800;
      let w = img.width, h = img.height;
      if (w > MAX || h > MAX) {
        if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
        else { w = Math.round(w * MAX / h); h = MAX; }
      }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      const compressed = c.toDataURL('image/jpeg', 0.7);
      if (currentPhotoIndex === -1) {
        extraPhotos.push(compressed);
        renderExtraPhotos();
      } else {
        photos[currentPhotoIndex] = compressed;
        try { localStorage.setItem(`yt_photo_${currentPhotoIndex}`, compressed); } catch(e) {}
        renderPhoto(currentPhotoIndex);
      }
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
});

function renderPhoto(index) {
  const el = document.getElementById(`photo${index + 1}`);
  if (photos[index]) {
    el.innerHTML = `<img src="${photos[index]}" /><button class="remove" onclick="event.stopPropagation();removePhoto(${index})">√ó</button>`;
  } else {
    el.innerHTML = '<span class="plus">+</span>';
  }
}

function removePhoto(index) {
  photos[index] = null;
  localStorage.removeItem(`yt_photo_${index}`);
  renderPhoto(index);
}

function addExtraPhoto() {
  currentPhotoIndex = -1;
  document.getElementById('photoInput').click();
}

function renderExtraPhotos() {
  const container = document.getElementById('extraPhotosContainer');
  container.innerHTML = extraPhotos.map((data, i) =>
    `<div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
      <div class="photo-slot" style="position:relative;">
        <img src="${data}" style="width:100%;height:100%;object-fit:cover;" />
        <button class="remove" onclick="event.stopPropagation();removeExtraPhoto(${i})">√ó</button>
      </div>
      <span style="color:var(--text2);font-size:11px;">Extra ${i+1}</span>
    </div>`
  ).join('');
}

function removeExtraPhoto(index) {
  extraPhotos.splice(index, 1);
  renderExtraPhotos();
}

// ============================================================================
// STYLE CHIPS
// ============================================================================
document.querySelectorAll('#layoutStyleChips .chip, #textStyleChips .chip, #textToneChips .chip').forEach(chip => {
  chip.addEventListener('click', () => {
    chip.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
  });
});

function getSelectedStyle() {
  return document.querySelector('#layoutStyleChips .chip.active')?.dataset.style || 'face-left-text-right';
}

function getSelectedTextStyle() {
  return document.querySelector('#textStyleChips .chip.active')?.dataset.textstyle || 'bold-white';
}

function getSelectedTone() {
  return document.querySelector('#textToneChips .chip.active')?.dataset.tone || 'curiosity';
}

// ============================================================================
// OPENAI CALLS
// ============================================================================
async function callOpenAI(messages, temperature = 0.9, max_tokens = 2000) {
  const key = getKey('openai');
  if (!key) { alert('Please enter your OpenAI API key'); return null; }

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
    body: JSON.stringify({ model: 'gpt-4o-mini', messages, temperature, max_tokens })
  });

  if (!res.ok) throw new Error(`OpenAI error: ${await res.text()}`);
  const data = await res.json();
  return data.choices[0].message.content;
}

// ============================================================================
// Feature 5: YOUTUBE URL FETCH
// ============================================================================
function extractVideoId(url) {
  const m = url.match(/(?:v=|\/shorts\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  return m ? m[1] : null;
}

async function fetchYouTubeInfo() {
  const url = document.getElementById('ytUrlInput').value.trim();
  if (!url) { alert('Enter a YouTube URL'); return; }

  try {
    // Try oEmbed first (most reliable from browser)
    const oembedRes = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
    if (oembedRes.ok) {
      const data = await oembedRes.json();
      const topicEl = document.getElementById('topicInput');
      topicEl.value = `Video Title: ${data.title}\nAuthor: ${data.author_name}\n\n(Paste transcript or additional details below)`;
      topicEl.focus();
      showToast('Fetched video info via oEmbed');
    } else {
      throw new Error('oEmbed failed');
    }
  } catch (err) {
    // Fallback: try lemnoslife API
    const videoId = extractVideoId(url);
    if (!videoId) { alert('Could not extract video ID from URL'); return; }
    try {
      const res = await fetch(`https://yt.lemnoslife.com/noKey/videos?part=snippet&id=${videoId}`);
      if (res.ok) {
        const data = await res.json();
        const snippet = data.items?.[0]?.snippet;
        if (snippet) {
          document.getElementById('topicInput').value = `Video Title: ${snippet.title}\n\nDescription: ${snippet.description}`;
          showToast('Fetched video info');
          return;
        }
      }
    } catch(e) {}
    alert('Could not fetch video info. Please paste the transcript manually.');
  }
}

// ============================================================================
// SUGGEST THUMBNAIL TEXT
// ============================================================================
async function suggestThumbTexts() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { alert('Enter a topic first'); return; }

  const el = document.getElementById('thumbTextSuggestions');
  el.innerHTML = '<span class="spinner"></span>';

  const tone = getSelectedTone();
  const toneInstructions = {
    'curiosity': 'Create a curiosity gap ‚Äî the viewer NEEDS to click to find out. Leave something unsaid.',
    'provocative': 'Be provocative and bold. Challenge assumptions.',
    'honest': 'Be raw and honest. No hype, just real talk.',
    'hype': 'Maximum excitement and energy. Celebrate wins.',
    'deadpan': 'Dry, understated, slightly ironic humor.',
    'contrarian': 'Go against the popular opinion.',
    'numbers': 'Lead with a specific number or data point.',
    'question': 'Ask a compelling question.',
  };

  try {
    const result = await callOpenAI([
      { role: 'system', content: `Generate 5 thumbnail text options for a YouTube video. TONE: ${toneInstructions[tone] || toneInstructions['curiosity']}

Rules:
- MAX 4 words per option, ALL CAPS
- Must reference something SPECIFIC from the video
- NO generic phrases
Return exactly 5 options, one per line, numbered 1-5. Nothing else.` },
      { role: 'user', content: topic.substring(0, 500) }
    ], 1.0);

    const options = result.split('\n').filter(l => l.trim()).map(l => l.replace(/^\d+[\.\)]\s*/, '').replace(/^["']|["']$/g, '').trim());
    el.innerHTML = options.map(t =>
      `<div class="chip" onclick="document.getElementById('thumbTextInput').value='${t.replace(/'/g, "\\'")}';document.querySelectorAll('#thumbTextSuggestions .chip').forEach(c=>c.classList.remove('active'));this.classList.add('active')" style="cursor:pointer;font-weight:600;">${t}</div>`
    ).join('');
  } catch (err) {
    el.innerHTML = `<span style="color:var(--accent);font-size:12px">${err.message}</span>`;
  }
}

// ============================================================================
// GENERATE TITLES
// ============================================================================
async function generateTitles() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { alert('Please enter a topic or transcript'); return; }

  const el = document.getElementById('titleResults');
  el.innerHTML = '<div><span class="spinner"></span> Generating titles...</div>';

  try {
    const result = await callOpenAI([
      { role: 'system', content: `You write YouTube titles for "${CHANNEL.name}" (${CHANNEL.handle}), run by ${CHANNEL.creator}.

About the channel:
${CHANNEL.bio}

TITLE RULES:
- Max 60 characters
- Titles must be SPECIFIC to what the video actually covers
- Pull real details from the transcript
- Talk like a real person
- NO generic clickbait, NO guru energy

Return exactly 10 titles, numbered 1-10. No quotes.` },
      { role: 'user', content: `Generate 10 YouTube titles for this video:\n\n${topic}` }
    ]);

    const titles = result.split('\n').filter(l => l.trim()).map(l => l.replace(/^\d+[\.\)]\s*/, '').replace(/^["']|["']$/g, ''));
    el.innerHTML = titles.map((t, i) =>
      `<div class="title-item" onclick="copyText(\`${t.replace(/`/g, '\\`')}\`)">
        <span class="num">${i + 1}</span>
        <span class="text">${t}</span>
        <span class="copy-icon">üìã</span>
      </div>`
    ).join('');

    // Feature 10: Save to history
    titles.forEach(t => addToHistory('title', t, topic));
  } catch (err) {
    el.innerHTML = `<div style="color:var(--accent)">${err.message}</div>`;
  }
}

// ============================================================================
// GENERATE DESCRIPTION
// ============================================================================
async function generateDescription() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { alert('Please enter a topic or transcript'); return; }

  const el = document.getElementById('descriptionResults');
  el.innerHTML = '<span class="spinner"></span> Generating description...';

  try {
    const result = await callOpenAI([
      { role: 'system', content: `You write YouTube descriptions for "${CHANNEL.name}" (${CHANNEL.handle}), run by ${CHANNEL.creator}.

CHANNEL CONTEXT:
${CHANNEL.bio}

DESCRIPTION FORMAT ‚Äî follow this structure exactly:

[Opening paragraph: 2-3 sentences that hook and summarize.]

[What I cover in this video ‚Äî bullet points with "‚Ä¢":]
‚Ä¢ point one
‚Ä¢ point two

[Optional: 1-2 sentence takeaway]

‚∏ª

üêù About The Appiarist
I'm building a hive of apps ‚Äî small projects, experiments, and products that compound over time.

‚∏ª

üîó Links
‚Ä¢ üåê ShipReactNative: ${CHANNEL.links.boilerplate}
‚Ä¢ üê¶ X / Twitter: ${CHANNEL.links.twitter}
‚Ä¢ üíº LinkedIn: ${CHANNEL.links.linkedin}
‚Ä¢ üåç Website: ${CHANNEL.links.website}

‚∏ª

üè∑Ô∏è Tags
[5-8 lowercase comma-separated tags]

STYLE: First person, conversational, honest. No corporate speak. First 150 chars matter most.` },
      { role: 'user', content: `Write a YouTube description for this video:\n\n${topic}` }
    ], 0.7);

    generatedDescriptionText = result;
    el.textContent = result;
    document.getElementById('descButtons').style.display = 'flex';

    // Feature 10: Save to history
    addToHistory('description', result.substring(0, 500), topic);
  } catch (err) {
    el.innerHTML = `<div style="color:var(--accent)">${err.message}</div>`;
  }
}

// ============================================================================
// Feature 8: COPY DESCRIPTION
// ============================================================================
function copyDescriptionRaw() {
  if (!generatedDescriptionText) { showToast('No description generated yet'); return; }
  navigator.clipboard.writeText(generatedDescriptionText).then(() => showToast('Copied raw text'));
}

function copyDescriptionMarkdown() {
  if (!generatedDescriptionText) { showToast('No description generated yet'); return; }
  // Already mostly markdown-compatible; ensure line breaks are preserved
  const md = generatedDescriptionText
    .replace(/^‚Ä¢ /gm, '- ')
    .replace(/‚∏ª/g, '---');
  navigator.clipboard.writeText(md).then(() => showToast('Copied as Markdown'));
}

// ============================================================================
// Feature 3: GENERATE TAGS
// ============================================================================
async function generateTags() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { alert('Please enter a topic or transcript'); return; }

  const el = document.getElementById('tagsResults');
  el.innerHTML = '<span class="spinner"></span> Generating tags...';

  try {
    const result = await callOpenAI([
      { role: 'system', content: `Generate 15-20 YouTube tags for the given video topic. Return ONLY comma-separated tags, lowercase, no numbering, no explanations. Tags should be relevant for YouTube SEO.` },
      { role: 'user', content: topic.substring(0, 1000) }
    ], 0.7, 500);

    const tags = result.split(',').map(t => t.trim()).filter(t => t);
    el.innerHTML = `
      <div class="tags-container">
        ${tags.map(t => `<div class="tag-chip" onclick="copyText('${t.replace(/'/g, "\\'")}')">${t}</div>`).join('')}
      </div>
      <div style="margin-top:12px;">
        <button class="btn btn-secondary" style="font-size:12px;" onclick="copyText('${tags.join(', ').replace(/'/g, "\\'")}')">Copy All Tags</button>
      </div>`;
  } catch (err) {
    el.innerHTML = `<div style="color:var(--accent)">${err.message}</div>`;
  }
}

// ============================================================================
// Feature 9: DARK/LIGHT PREVIEW
// ============================================================================
function setPreviewMode(mode) {
  previewMode = mode;
  const card = document.getElementById('thumbnailCard');
  if (mode === 'dark') {
    card.style.background = '#0F0F0F';
    document.getElementById('previewDarkBtn').className = 'active-preview';
    document.getElementById('previewLightBtn').className = 'inactive-preview';
  } else {
    card.style.background = '#FFFFFF';
    document.getElementById('previewDarkBtn').className = 'inactive-preview';
    document.getElementById('previewLightBtn').className = 'active-preview';
  }
}

// ============================================================================
// GENERATE THUMBNAIL (Feature 4: 3 variations)
// ============================================================================
async function generateThumbnail() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { alert('Please enter a topic or transcript'); return; }

  const gKey = getKey('gemini');
  if (!gKey) { alert('Please enter your Google Gemini API key'); return; }

  const faceData = photos[0];
  if (!faceData) { alert('Upload your face photo first'); return; }

  const el = document.getElementById('thumbnailResults');
  const promptEl = document.getElementById('thumbnailPrompt');
  el.innerHTML = '<div class="thumbnail-item"><div class="loading"><span class="spinner"></span> Generating 3 thumbnail variations...</div></div>';

  const style = getSelectedStyle();
  let thumbText = document.getElementById('thumbTextInput').value.trim();

  if (!thumbText) {
    alert('Enter thumbnail text or click "‚ú® Suggest from topic" first');
    el.innerHTML = '<div class="thumbnail-item"><div class="loading">Generate to create thumbnails</div></div>';
    return;
  }

  try {
    const textStyle = getSelectedTextStyle();
    const textStyleDesc = {
      'bold-white': 'very large, bold, white Impact-style font with a thick black outline',
      'yellow-bold': 'very large, bold, bright yellow font with a thick black outline',
      'red-highlight': 'large bold white font inside a red rectangular highlight box',
      'neon-glow': 'large bold font with a bright neon glow effect',
      'gradient-text': 'very large bold font with a gradient fill',
      '3d-text': 'very large bold white 3D-style font with strong drop shadow',
      'handwritten': 'large handwritten or marker-style font',
      'glitch': 'large bold font with a digital glitch/distortion effect',
    }[textStyle] || 'very large, bold, white Impact-style font with a thick black outline';

    const t = thumbText;
    const td = textStyleDesc;
    const topicShort = topic.substring(0, 60);
    const styleInstructions = {
      'face-left-text-right': `Edit this photo into a wide 16:9 YouTube thumbnail. Place the person on the left 35%, chest up. Right 65%: "${t}" in ${td}. Background: solid pure black. Clean, minimal, high contrast.`,
      'face-center-text-top': `Edit this photo into a wide 16:9 YouTube thumbnail. Person centered, chest up. Professional gradient background. "${t}" in ${td} at the top.`,
      'face-with-icon': `Edit this photo into a wide 16:9 YouTube thumbnail. Person on left 35%. Right: large icon for "${topicShort}". "${t}" in ${td}. Dark gradient background.`,
      'screenshot-reaction': `Edit this photo into a wide 16:9 YouTube thumbnail. LEFT 55%: screenshot related to "${topicShort}". RIGHT 45%: person reacting. "${t}" in ${td} at bottom center.`,
      'dramatic': `Edit this photo into a wide 16:9 YouTube thumbnail. Person left of center, cinematic. Background: pitch black. Orange rim lighting from left. "${t}" in ${td} on right.`,
      'dramatic-blue': `Edit this photo into a wide 16:9 YouTube thumbnail. Person right of center. Dark navy background with blue neon backlighting. "${t}" in ${td} on left. Cyberpunk mood.`,
      'dramatic-red': `Edit this photo into a wide 16:9 YouTube thumbnail. Person left of center. Dark with deep red glow from below. "${t}" in ${td} on right. Urgent vibe.`,
      'split': `Edit this photo into a wide 16:9 YouTube thumbnail. BEFORE/AFTER split. Left: desaturated, frustrated. Right: vibrant, confident. "${t}" in ${td} spanning center.`,
      'podcast-style': `Edit this photo into a wide 16:9 YouTube thumbnail. Person at desk setup, monitor behind. "${t}" in ${td}. Indie dev workstation vibe.`,
      'breaking-news': `Edit this photo into a wide 16:9 YouTube thumbnail. Person left 40%. Alert/announcement feel with geometric accents. Bold banner: "${t}" in ${td}.`,
      'versus': `Edit this photo into a wide 16:9 YouTube thumbnail. Person left, "VS" center, opposing icon right for "${topicShort}". "${t}" in ${td} at top.`,
      'ranking-list': `Edit this photo into a wide 16:9 YouTube thumbnail. Person right 30% pointing left. Left: ranked list for "${topicShort}". "${t}" as header in ${td}.`,
    };

    let basePrompt = `${styleInstructions[style] || styleInstructions['face-left-text-right']}

Important: Output must be 16:9 landscape. Preserve facial features exactly. All text "${thumbText}" must be fully visible. No extra text.`;

    const frameData = photos[1];
    if (frameData) basePrompt += `\n\nA reference frame from the video is provided. Match mood/lighting.`;
    if (extraPhotos.length > 0) basePrompt += `\n\n${extraPhotos.length} additional image(s) provided. Incorporate them naturally.`;

    promptEl.innerHTML = `<div class="prompt-preview">Text: ${thumbText} | Style: ${style} | Generating 3 variations...</div>`;

    // Feature 4: Generate 3 variations in parallel
    const variations = [
      "variation 1: slightly different composition",
      "variation 2: alternative color treatment",
      "variation 3: different text placement"
    ];

    const promises = variations.map((v, i) =>
      callGeminiImage(
        basePrompt + `\n\n${v}`,
        faceData, frameData, extraPhotos
      ).catch(err => null)
    );

    const results = await Promise.all(promises);
    lastGeneratedImages = results.filter(r => r);

    if (lastGeneratedImages.length === 0) {
      throw new Error('All thumbnail generations failed. Try again.');
    }

    el.innerHTML = lastGeneratedImages.map((img, i) => `
      <div class="thumbnail-item">
        <img src="${img}" alt="Thumbnail variation ${i+1}" />
      </div>
    `).join('');

    // Actions row
    const actionsHtml = `
      <div class="thumbnail-actions">
        ${lastGeneratedImages.map((img, i) => `
          <a href="${img}" download="thumbnail_v${i+1}.jpg" class="btn btn-secondary" style="text-decoration:none;font-size:12px;">DL v${i+1}</a>
          <button class="btn btn-ghost" style="font-size:12px;" onclick="downloadAt1280x720(${i})">1280√ó720 v${i+1}</button>
          <button class="btn btn-ghost" style="font-size:12px;" onclick="saveFavorite(${i})">‚≠ê Save v${i+1}</button>
        `).join('')}
        <button class="btn btn-ghost" style="font-size:12px;" onclick="generateThumbnail()">üîÑ Regenerate</button>
        ${lastGeneratedImages.length >= 2 ? `<button class="btn btn-secondary" style="font-size:12px;" onclick="openABModal()">A/B Compare</button>` : ''}
      </div>`;
    el.insertAdjacentHTML('afterend', '');
    // Put actions after the grid
    const existingActions = document.querySelectorAll('#thumbnailCard > .thumbnail-actions');
    existingActions.forEach(a => a.remove());
    el.insertAdjacentHTML('afterend', actionsHtml);

    // Show tweak section
    document.getElementById('tweakSection').style.display = 'block';

    // Feature 10: Save thumbnails to history (compressed)
    lastGeneratedImages.forEach((img, i) => {
      compressImage(img, 300).then(compressed => {
        addToHistory('thumbnail', compressed, topic);
      });
    });

  } catch (err) {
    el.innerHTML = `<div class="thumbnail-item"><div class="loading" style="color:var(--accent)">${err.message}</div></div>`;
  }
}

// ============================================================================
// Feature 1: TWEAK THUMBNAIL
// ============================================================================
async function tweakThumbnail() {
  const tweakText = document.getElementById('tweakInput').value.trim();
  if (!tweakText) { alert('Enter tweak instructions'); return; }
  if (lastGeneratedImages.length === 0) { alert('No thumbnail to tweak'); return; }

  const el = document.getElementById('thumbnailResults');
  el.innerHTML = '<div class="thumbnail-item"><div class="loading"><span class="spinner"></span> Tweaking thumbnail...</div></div>';

  try {
    // Use the first generated image as base for tweaking
    const baseImage = lastGeneratedImages[0];
    const result = await callGeminiImage(
      `Edit this thumbnail image with the following adjustments: ${tweakText}. Keep the overall composition but apply the requested changes. Output must remain 16:9 landscape.`,
      baseImage
    );

    if (result) {
      lastGeneratedImages = [result];
      el.innerHTML = `<div class="thumbnail-item"><img src="${result}" alt="Tweaked thumbnail" /></div>`;
      
      const actionsHtml = `
        <div class="thumbnail-actions">
          <a href="${result}" download="thumbnail_tweaked.jpg" class="btn btn-secondary" style="text-decoration:none;font-size:12px;">Download</a>
          <button class="btn btn-ghost" style="font-size:12px;" onclick="downloadAt1280x720(0)">1280√ó720</button>
          <button class="btn btn-ghost" style="font-size:12px;" onclick="saveFavorite(0)">‚≠ê Save</button>
          <button class="btn btn-ghost" style="font-size:12px;" onclick="generateThumbnail()">üîÑ Regenerate</button>
        </div>`;
      const existingActions = document.querySelectorAll('#thumbnailCard > .thumbnail-actions');
      existingActions.forEach(a => a.remove());
      el.insertAdjacentHTML('afterend', actionsHtml);
    }
  } catch (err) {
    el.innerHTML = `<div class="thumbnail-item"><div class="loading" style="color:var(--accent)">${err.message}</div></div>`;
  }

  document.getElementById('tweakInput').value = '';
}

// ============================================================================
// Feature 7: EXPORT AT 1280x720
// ============================================================================
function downloadAt1280x720(index) {
  const imgSrc = lastGeneratedImages[index];
  if (!imgSrc) return;

  const img = new Image();
  img.onload = () => {
    const c = document.createElement('canvas');
    c.width = 1280; c.height = 720;
    c.getContext('2d').drawImage(img, 0, 0, 1280, 720);
    const link = document.createElement('a');
    link.download = `thumbnail_${index+1}_1280x720.jpg`;
    link.href = c.toDataURL('image/jpeg', 0.95);
    link.click();
  };
  img.src = imgSrc;
}

// ============================================================================
// Feature 2: FAVORITES
// ============================================================================
function compressImage(dataUrl, maxWidth) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      resolve(c.toDataURL('image/jpeg', 0.7));
    };
    img.src = dataUrl;
  });
}

async function saveFavorite(index) {
  const imgSrc = lastGeneratedImages[index];
  if (!imgSrc) return;

  const compressed = await compressImage(imgSrc, 400);
  const favorites = JSON.parse(localStorage.getItem('yt_favorites') || '[]');

  favorites.push({
    image: compressed,
    text: document.getElementById('thumbTextInput').value.trim(),
    style: getSelectedStyle(),
    timestamp: Date.now()
  });

  // FIFO: max 20
  while (favorites.length > 20) favorites.shift();

  try {
    localStorage.setItem('yt_favorites', JSON.stringify(favorites));
    showToast('‚≠ê Saved to favorites');
    renderFavorites();
  } catch (e) {
    // Quota exceeded ‚Äî remove oldest and retry
    favorites.shift();
    try {
      localStorage.setItem('yt_favorites', JSON.stringify(favorites));
      showToast('‚≠ê Saved (removed oldest to fit)');
      renderFavorites();
    } catch(e2) {
      showToast('Storage quota exceeded');
    }
  }
}

function removeFavorite(index) {
  const favorites = JSON.parse(localStorage.getItem('yt_favorites') || '[]');
  favorites.splice(index, 1);
  localStorage.setItem('yt_favorites', JSON.stringify(favorites));
  renderFavorites();
}

function renderFavorites() {
  const favorites = JSON.parse(localStorage.getItem('yt_favorites') || '[]');
  const grid = document.getElementById('favoritesGrid');
  if (favorites.length === 0) {
    grid.innerHTML = '<p style="color:var(--text2);font-size:13px;">No favorites yet. Save thumbnails with the ‚≠ê button.</p>';
    return;
  }
  grid.innerHTML = favorites.map((f, i) => `
    <div class="fav-item">
      <img src="${f.image}" alt="Favorite ${i+1}" />
      <button class="fav-remove" onclick="removeFavorite(${i})">√ó</button>
      <div class="fav-meta">
        ${f.text ? `<div>"${f.text}"</div>` : ''}
        <div>${new Date(f.timestamp).toLocaleDateString()}</div>
      </div>
    </div>
  `).join('');
}

// ============================================================================
// Feature 6: A/B COMPARE
// ============================================================================
function openABModal() {
  if (lastGeneratedImages.length < 2) { alert('Need at least 2 thumbnails to compare'); return; }
  const modal = document.getElementById('abModal');
  const imgs = lastGeneratedImages.slice(0, 2);

  function makeRow(containerId) {
    const row = document.getElementById(containerId);
    row.innerHTML = imgs.map((img, i) => `
      <div class="ab-thumb" onclick="pickABWinner(${i})">
        <img src="${img}" alt="Option ${i+1}" />
      </div>
    `).join('<span style="color:var(--text2);font-size:20px;font-weight:bold;">VS</span>');
  }

  makeRow('abRowLight');
  makeRow('abRowDark');
  modal.style.display = 'flex';
}

function pickABWinner(index) {
  showToast(`üèÜ Variation ${index + 1} wins!`);
  closeABModal();
}

function closeABModal() {
  document.getElementById('abModal').style.display = 'none';
}

// ============================================================================
// Feature 10: HISTORY
// ============================================================================
function addToHistory(type, content, topic) {
  const history = JSON.parse(localStorage.getItem('yt_history') || '[]');
  history.push({ type, content, timestamp: Date.now(), topic: (topic || '').substring(0, 200) });
  while (history.length > 50) history.shift();
  try {
    localStorage.setItem('yt_history', JSON.stringify(history));
  } catch(e) {
    // If quota exceeded, trim more aggressively
    while (history.length > 20) history.shift();
    try { localStorage.setItem('yt_history', JSON.stringify(history)); } catch(e2) {}
  }
}

function toggleHistory() {
  const list = document.getElementById('historyList');
  const icon = document.getElementById('historyToggleIcon');
  if (list.style.display === 'none') {
    list.style.display = 'block';
    icon.textContent = '‚ñº';
    renderHistory();
  } else {
    list.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

function clearHistory() {
  localStorage.removeItem('yt_history');
  renderHistory();
  showToast('History cleared');
}

function renderHistory() {
  const history = JSON.parse(localStorage.getItem('yt_history') || '[]');
  const list = document.getElementById('historyList');
  if (history.length === 0) {
    list.innerHTML = '<p style="color:var(--text2);font-size:13px;">No history yet.</p>';
    return;
  }
  list.innerHTML = history.slice().reverse().map(entry => {
    const date = new Date(entry.timestamp).toLocaleString();
    const typeEmoji = { thumbnail: 'üé®', title: 'üìù', description: 'üìÑ' }[entry.type] || 'üì¶';
    let contentHtml;
    if (entry.type === 'thumbnail' && entry.content.startsWith('data:')) {
      contentHtml = `<img src="${entry.content}" alt="thumbnail" />`;
    } else {
      contentHtml = entry.content.substring(0, 300) + (entry.content.length > 300 ? '...' : '');
    }
    return `<div class="history-entry">
      <div class="h-type">${typeEmoji} ${entry.type}</div>
      <div class="h-time">${date}</div>
      <div class="h-content">${contentHtml}</div>
    </div>`;
  }).join('');
}

// ============================================================================
// GENERATE ALL
// ============================================================================
async function generateAll() {
  const btn = document.getElementById('generateAll');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Generating...';

  try {
    await Promise.all([
      generateTitles(),
      generateDescription(),
      generateThumbnail(),
      generateTags(),
    ]);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Generate All';
  }
}

// ============================================================================
// UTILS
// ============================================================================
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard'));
}

function showToast(msg) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2000);
}
</script>
</body>
</html>
